<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Antrian Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="flex items-center justify-center h-screen bg-gray-100">
  <div class="bg-white p-6 rounded-xl shadow-md w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-4">Form Antrian</h1>
    <form id="antrianForm" class="space-y-4">

      <!-- Nama Satker -->
      <div class="relative">
        <label for="nama">Nama Satker</label>
        <input type="text" id="nama" name="nama" 
          class="w-full p-2 border rounded" autocomplete="off">
        <ul id="namaSuggestions" 
            class="absolute left-0 right-0 bg-white border rounded shadow max-h-48 overflow-y-auto hidden z-50"></ul>
      </div>

      <!-- Kode Satker -->
      <div class="relative">
        <label for="kode">Kode Satker</label>
        <input type="text" id="kode" name="kode" 
          class="w-full p-2 border rounded" autocomplete="off">
        <ul id="kodeSuggestions" 
            class="absolute left-0 right-0 bg-white border rounded shadow max-h-48 overflow-y-auto hidden z-50"></ul>
      </div>


      <input type="tel" id="handphone" placeholder="Nomor HP" required pattern="^08[0-9]{8,11}$" class="w-full p-2 border rounded">
      <textarea id="deskripsi" placeholder="Deskripsi / Konsultasi" class="w-full p-2 border rounded"></textarea>
      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Submit</button>
    </form>

    <!-- Success State -->
    <div id="success" class="hidden text-center mt-6">
      <div class="text-green-500 text-5xl">âœ”</div>
      <p class="text-lg font-semibold mt-2">Terima kasih, data berhasil dikirim!</p>
    </div>
  </div>
  
  <script>
    const { createClient } = supabase;
    const supabaseUrl = "https://finxocxyrjizxjvvcbim.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpbnhvY3h5cmppenhqdnZjYmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5ODM1MjcsImV4cCI6MjA3MzU1OTUyN30.wK5N8xoDococE7AfACmP8LPh-nXE-lqKZte15MSM8P4";

  const supabaseClient = createClient(supabaseUrl, supabaseKey);

 // Debounce helper (to avoid spamming Supabase)
function debounce(fn, delay) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), delay);
  };
}

const form = document.getElementById("antrianForm");
const successDiv = document.getElementById("success");

const namaInput = document.getElementById("nama");
const kodeInput = document.getElementById("kode");
const namaSuggestions = document.getElementById("namaSuggestions");
const kodeSuggestions = document.getElementById("kodeSuggestions");

// Fetch Nama Satker suggestions
async function fetchNamaSuggestions(query) {
  if (!query) {
    namaSuggestions.classList.add("hidden");
    return;
  }

  const { data, error } = await supabaseClient
    .from("satker")
    .select("nama, kode")
    .ilike("nama", `%${query}%`)
    .limit(10);

  if (error) return console.error(error);

  namaSuggestions.innerHTML = "";
  data.forEach(item => {
    const li = document.createElement("li");
    li.textContent = item.nama;
    li.className = "p-2 hover:bg-blue-100 cursor-pointer";
    li.onclick = () => {
      namaInput.value = item.nama;
      kodeInput.value = item.kode; // autofill kode
      namaSuggestions.classList.add("hidden");
    };
    namaSuggestions.appendChild(li);
  });

  namaSuggestions.classList.toggle("hidden", data.length === 0);
}

// Fetch Kode Satker suggestions
async function fetchKodeSuggestions(query) {
  if (!query) {
    kodeSuggestions.classList.add("hidden");
    return;
  }

  const { data, error } = await supabaseClient
    .from("satker")
    .select("kode, nama")
    .ilike("kode", `%${query}%`)
    .limit(10);

  if (error) return console.error(error);

  kodeSuggestions.innerHTML = "";
  data.forEach(item => {
    const li = document.createElement("li");
    li.textContent = item.kode;
    li.className = "p-2 hover:bg-blue-100 cursor-pointer";
    li.onclick = () => {
      kodeInput.value = item.kode;
      namaInput.value = item.nama; // autofill nama
      kodeSuggestions.classList.add("hidden");
    };
    kodeSuggestions.appendChild(li);
  });

  kodeSuggestions.classList.toggle("hidden", data.length === 0);
}

// Attach events with debounce
namaInput.addEventListener("input", debounce((e) => {
  fetchNamaSuggestions(e.target.value);
}, 300));

kodeInput.addEventListener("input", debounce((e) => {
  fetchKodeSuggestions(e.target.value);
}, 300));

// Hide suggestions if clicked outside
document.addEventListener("click", (e) => {
  if (!namaInput.contains(e.target) && !namaSuggestions.contains(e.target)) {
    namaSuggestions.classList.add("hidden");
  }
  if (!kodeInput.contains(e.target) && !kodeSuggestions.contains(e.target)) {
    kodeSuggestions.classList.add("hidden");
  }
});


  // ðŸ”¹ Submit form
  form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const nama = namaInput.value;
  const kode = kodeInput.value;
  const phone = document.getElementById("handphone").value;
  const deskripsi = document.getElementById("deskripsi").value;

  const { error } = await supabaseClient
    .from("antrian")
    .insert([{ nama, kode, phone, deskripsi }]);

  if (error) {
    alert("Gagal kirim data: " + error.message);
  } else {
    form.classList.add("hidden");
    successDiv.classList.remove("hidden");
  }
});

</script>

</body>
</html>
