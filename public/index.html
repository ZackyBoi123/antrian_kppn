<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antrian Form</title>
  <link rel="stylesheet" href="output.css">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script defer src="/_vercel/insights/script.js"></script>
  <style>
    
body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

h1 {
	text-align: center;
	color: #2563eb;
	font-size: 2rem;
	margin-bottom: 0.75rem;
	letter-spacing: 1px;
}

form label {
	display: block;
	margin-bottom: 0.3rem;
	color: #374151;
	font-weight: 500;
}

form textarea {
	width: 100%;
	padding: 0.7rem 1rem;
	border: 1px solid #d1d5db;
	border-radius: 8px;
	margin-bottom: 1rem;
	font-size: 1rem;
	background: #f9fafb;
	transition: border 0.2s;
}

form button[type="submit"] {
	background: linear-gradient(90deg, #2563eb 60%, #60a5fa 100%);
	color: #fff;
	border: none;
	padding: 0.8rem 0;
	border-radius: 8px;
	font-size: 1.1rem;
	font-weight: 600;
	cursor: pointer;
	transition: background 0.2s, transform 0.1s;
	box-shadow: 0 2px 8px rgba(37,99,235,0.08);
}

form button[type="submit"]:hover {
	background: linear-gradient(90deg, #1d4ed8 60%, #3b82f6 100%);
	transform: translateY(-2px) scale(1.03);
}

/* Suggestions dropdown */
.suggestions-dropdown {
  position: absolute;
  top: 90%;
  left: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  max-height: 200px;
  overflow-y: auto;
  z-index: 50;
  margin-top: 8px;
}

.suggestion-item {
  padding: 1rem 1.25rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 1px solid rgba(102, 126, 234, 0.05);
}

.suggestion-item:hover {
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  font-weight: 600;
}

.suggestion-item:last-child {
  border-bottom: none;
}

/* Custom scrollbar */
.suggestions-dropdown::-webkit-scrollbar {
  width: 4px;
}

.suggestions-dropdown::-webkit-scrollbar-track {
  background: transparent;
}

.suggestions-dropdown::-webkit-scrollbar-thumb {
  background: rgba(102, 126, 234, 0.3);
  border-radius: 2px;
}

.suggestions-dropdown::-webkit-scrollbar-thumb:hover {
  background: rgba(102, 126, 234, 0.5);
}

#success {
	text-align: center;
}
#success .text-green-500 {
	font-size: 3rem;
	margin-bottom: 0.5rem;
}

@media (max-width: 600px) {
	h1 {
		font-size: 1.3rem;
	}
}

/* FLOATING LABEL */
.floating-label {
  position: absolute;
  left: 1.25rem;
  top: 0.95rem;
  font-size: 1.10rem;
  font-weight: 500;
  color: #64748b;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  pointer-events: none;
  background: transparent;
}

.form-input {
  width: 100%;
  padding: 1rem 1.25rem;
  border: 2px solid rgba(102, 126, 234, 0.1);
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.8);
  font-size: 1rem;
  font-weight: 500;
  transition: all 0.3s ease;
  outline: none;
  backdrop-filter: blur(10px);
}

 .form-input:focus {
   border-color: #667eea;
   background: rgba(255, 255, 255, 0.95);
   box-shadow: 
     0 0 0 4px rgba(102, 126, 234, 0.1),
     0 4px 16px rgba(102, 126, 234, 0.15);
   transform: translateY(-2px);
}
 .form-input:not(:placeholder-shown) {
  border-color: #667eea;
}
    
.form-input:focus + .floating-label,
.form-input:not(:placeholder-shown) + .floating-label {
  top: -12px;
  left: 1rem;
  font-size: 0.875rem;
  font-weight: 600;
  color: #667eea;
  background: rgba(255, 255, 255, 0.9);
  padding: 0 8px;
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

@media (max-width: 600px) {
  form textarea {
    font-size: 1rem;
    padding: 1rem;
  }
  form button[type="submit"] {
    padding: 1rem;
    font-size: 1.1rem;
  }
}

/* start hidden (removed from flow) */
.error-msg {
  display: none;                 /* removed from layout when hidden */
  opacity: 0;
  transform: translateY(-6px);
  transition: opacity 280ms ease, transform 280ms ease;
  max-width: 100%;
  font-size: 1.05rem;
  padding: 0.5rem 0.75rem;
  border-radius: 8px;
  background: rgba(220, 38, 38, 0.08);
  color: #b91c1c;
  font-weight: 600;
}

/* visible state â€” animates in */
.error-msg.visible {
  display: block; /* make it participate in layout before animation */
  opacity: 1;
  transform: translateY(0);
}

  </style>
</head>
<body class="flex items-center justify-center h-screen bg-gray-300">
  <div class="bg-white p-6 m-6 rounded-xl shadow-md w-full max-w-md">

    <h1 id="header" class="text-3xl font-bold text-center">Form Antrian</h1>
    <form id="antrianForm" class="space-y-4">

      <div id="errorMSG" class="error-msg hidden" role="alert" aria-live="assertive" aria-atomic="true"></div>

      <!-- Nama Satker -->
      <div class="relative rounded-xl">
        <input type="text" id="nama" name="nama" placeholder=" " class="form-input" autocomplete="off"/>
        <label class="floating-label">Nama Satker</label>
        <ul id="namaSuggestions" 
            class="suggestions-dropdown hidden"></ul>
      </div>

      <!-- Kode Satker -->
      <div class="relative">
        <input type="text" id="kode" name="kode" placeholder=" " class="form-input" autocomplete="off">
        <label class="floating-label">Kode Satker</label>
        <ul id="kodeSuggestions" 
            class="suggestions-dropdown hidden"></ul>
      </div>

    <div class="relative">
      <input type="number" id="handphone" placeholder=" " class="form-input">
      <label class="floating-label">Nomor HP</label>
    </div>

    <div class="relative">
      <textarea id="deskripsi" placeholder=" " class="form-input"></textarea>
      <label class="floating-label">Konsultasi</label>
    </div>

      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Submit</button>
    </form>

    <!-- Success State -->
    <div id="success" class="hidden text-center">
      <p class="text-gray-600">Nomor Antrian Anda:</p>
      <div id="nomorDisplay" class="text-5xl font-bold text-blue-600 mt-2 mb-2"></div>
      <p class="text-lg font-semibold mt-2">Terima kasih, data berhasil dikirim!</p>
    </div>
  </div>
  
  <script>
    const { createClient } = supabase;
    const supabaseUrl = "https://finxocxyrjizxjvvcbim.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpbnhvY3h5cmppenhqdnZjYmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5ODM1MjcsImV4cCI6MjA3MzU1OTUyN30.wK5N8xoDococE7AfACmP8LPh-nXE-lqKZte15MSM8P4";

    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    //* Wire up Vercel Analytics
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };

  // Debounce helper (to avoid spamming Supabase)
  function debounce(fn, delay) {
    let timer;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  const form = document.getElementById("antrianForm");
  const successDiv = document.getElementById("success");
  const h1 = document.getElementById("header");
  let transitionHandler = null;
  let errorTimer = null;

  const namaInput = document.getElementById("nama");
  const kodeInput = document.getElementById("kode");
  const namaSuggestions = document.getElementById("namaSuggestions");
  const kodeSuggestions = document.getElementById("kodeSuggestions");

// Show error message
function showError(message, timeout = 3000) {
  const errorMSG = document.getElementById("errorMSG");
  errorMSG.textContent = message;

  // clear previous timeout and transition handler (if any)
  if (errorTimer) {
    clearTimeout(errorTimer);
    errorTimer = null;
  }
  if (transitionHandler) {
    errorMSG.removeEventListener('transitionend', transitionHandler);
    transitionHandler = null;
  }

  // If element already visible, restart animation cleanly
  if (errorMSG.style.display === 'block') {
    // restart by forcing reflow and toggling class
    errorMSG.classList.remove('visible');
    void errorMSG.offsetWidth;
    errorMSG.classList.add('visible');
  } else {
    // Make block so it takes space, then on next frame add `.visible` to animate
    errorMSG.style.display = 'block';
    // double RAF is a reliable way to start the transition across browsers
    requestAnimationFrame(() => requestAnimationFrame(() => errorMSG.classList.add('visible')));
  }

  // schedule hide after timeout
  errorTimer = setTimeout(() => hideError(errorMSG), timeout);
}

function hideError(el) {
  // remove visible class -> triggers transition to opacity:0 + translateY
  el.classList.remove('visible');

  // ensure we don't attach multiple handlers
  if (transitionHandler) {
    el.removeEventListener('transitionend', transitionHandler);
    transitionHandler = null;
  }

  // wait for transition to finish then set display:none
  transitionHandler = function onEnd(e) {
    // guard: only respond to opacity transition (avoids multiple fires)
    if (e.propertyName !== 'opacity') return;
    el.style.display = 'none';
    el.removeEventListener('transitionend', transitionHandler);
    transitionHandler = null;
  };

  el.addEventListener('transitionend', transitionHandler);

  // fallback: if transitionend doesn't fire (reduced-motion, weird browser),
  // forcibly hide after transition duration + small buffer
  setTimeout(() => {
    if (transitionHandler) {
      el.style.display = 'none';
      el.removeEventListener('transitionend', transitionHandler);
      transitionHandler = null;
    }
  }, 350);
}

  // Fetch Nama Satker suggestions
  async function fetchNamaSuggestions(query) {
    if (!query) {
      namaSuggestions.classList.add("hidden");
      return;
    }

    const { data, error } = await supabaseClient
      .from("satker")
      .select("nama, kode")
      .ilike("nama", `%${query}%`)
      .limit(10);

    if (error) return console.error(error);

    namaSuggestions.innerHTML = "";
    data.forEach(item => {
      const li = document.createElement("li");
      li.textContent = item.nama;
      li.className = "p-2 hover:bg-blue-100 cursor-pointer";
      li.onclick = () => {
        namaInput.value = item.nama;
        kodeInput.value = item.kode; // autofill kode
        namaSuggestions.classList.add("hidden");
      };
      namaSuggestions.appendChild(li);
    });

    namaSuggestions.classList.toggle("hidden", data.length === 0);
  }

  // Fetch Kode Satker suggestions
  async function fetchKodeSuggestions(query) {
    if (!query) {
      kodeSuggestions.classList.add("hidden");
      return;
    }

    const { data, error } = await supabaseClient
      .from("satker")
      .select("kode, nama")
      .ilike("kode", `%${query}%`)
      .limit(10);

    if (error) return console.error(error);

    kodeSuggestions.innerHTML = "";
    data.forEach(item => {
      const li = document.createElement("li");
      li.textContent = item.kode;
      li.className = "p-2 hover:bg-blue-100 cursor-pointer";
      li.onclick = () => {
        kodeInput.value = item.kode;
        namaInput.value = item.nama; // autofill nama
        kodeSuggestions.classList.add("hidden");
      };
      kodeSuggestions.appendChild(li);
    });

    kodeSuggestions.classList.toggle("hidden", data.length === 0);
  }

  // Attach events with debounce
  namaInput.addEventListener("input", debounce((e) => {
    fetchNamaSuggestions(e.target.value);
  }, 50));

  kodeInput.addEventListener("input", debounce((e) => {
    fetchKodeSuggestions(e.target.value);
  }, 50));

  // Hide suggestions if clicked outside
  document.addEventListener("click", (e) => {
    if (!namaInput.contains(e.target) && !namaSuggestions.contains(e.target)) {
      namaSuggestions.classList.add("hidden");
    }
    if (!kodeInput.contains(e.target) && !kodeSuggestions.contains(e.target)) {
      kodeSuggestions.classList.add("hidden");
    }
  });

    // ðŸ”¹ Submit form
    form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const nama = namaInput.value;
    const kode = kodeInput.value;
    const phone = document.getElementById("handphone").value;
    const deskripsi = document.getElementById("deskripsi").value;

    const errorMSG = document.getElementById("errorMSG");

    if (!nama || !kode || !phone || !deskripsi) {
      showError("Harap Isi Semua Kolom!");
      return;
    }

    if (kode.length < 6) {
      showError("Kode Satker tidak valid! (Minimal 6 karakter)");
      return;
    }

    if (!/^08\d*$/.test(phone)) {
      showError("Nomor HP tidak valid! (Harus diawali 08)");
      return;
    }

    const { data ,error } = await supabaseClient
      .from("antrian")
      .insert([{ nama, kode, phone, deskripsi }])
      .select("nomor_antrian")
      .single();

    if (error) {
      alert("Gagal kirim data: " + error.message);
    } else {
      form.classList.add("hidden");
      h1.classList.add("hidden");
      successDiv.classList.remove("hidden");
    }

      // Show nomor antrian
      document.getElementById("nomorDisplay").textContent = data.nomor_antrian;
});
  </script>
</body>
</html>
