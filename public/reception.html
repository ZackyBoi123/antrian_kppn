<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Antrian</title>
    <link rel="stylesheet" href="output.css">
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      /* Import font */
      @import url("https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap");
      /* Body */
      body {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #E1BB80 ,#D6D6B1);
        background-repeat: no-repeat;
        background-attachment: fixed;
        padding: 20px;
      }

      /* Animated grid background */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          linear-gradient(#E1BB80 1px, transparent 1px),
          linear-gradient(90deg, #D6D6B1 1px, transparent 1px);
        background-size: 100px 100px;
        animation: gridMove 30s linear infinite;
        pointer-events: none;
        z-index: -1;
      }
      
      @keyframes gridMove {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
      }

      /* Table styles */
      .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      .modern-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(30, 41, 59, 0.95); /* Slightly more opaque for better visibility */
        backdrop-filter: blur(20px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Add shadow when scrolling */
      }

      .modern-table th {
        background: #685634;
        backdrop-filter: blur(20px);
        color: #f1f5f9;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 1.5rem 1rem;
        font-size: 0.95rem;
        border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        position: relative;
      }

      .modern-table th:not(:last-child)::after {
        content: '';
        position: absolute;
        right: 0;
        top: 25%;
        height: 50%;
        width: 1px;
        background: rgba(148, 163, 184, 0.2);
      }

      .modern-table td {
        padding: 1.25rem 1rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        color: white;
        font-size: 0.75rem;
        font-weight: 300;
        position: relative;
        transition: all 0.2s ease;
      }

      .modern-table tbody tr {
        transition: all 0.3s ease;
        position: relative;
      }

      .modern-table tbody tr::before {
        position: absolute;
        left: 0;
        top: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .modern-table tbody tr:hover::before {
        opacity: 1;
      }

      .modern-table tbody tr:hover, 
      .modern-table tbody tr:nth-child(even):hover {
        background: rgba(53, 144, 255, 0.178);
        box-shadow: 0 4px 12px rgba(96, 165, 250, 0.15);
      }

      .modern-table tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.02);
      }

      /* Tombol Print */
      button {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        position: relative;
        overflow: hidden;
      }

      button:hover {
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
      }

      button:active {
        transform: translateY(-1px) scale(1.02);
      }

      /* New entry animation */
      .new-entry {
        animation: newEntrySlide 0.6s ease-out;
      }

      @keyframes newEntrySlide {
        0% {
          opacity: 0;
          transform: translateX(100%) scale(0.8);
        }
        50% {
          opacity: 0.5;
          transform: translateX(-5%) scale(1.05);
        }
        100% {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
      }

      /* Time formatting */
      .time-display {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 1.09rem;
        color: #ccc5c5;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #64748b;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      /* Pulse effect for active elements */
      .pulse-glow {
        animation: pulseGlow 2s ease-in-out infinite;
      }

      @keyframes pulseGlow {
        0%, 100% { box-shadow: 0 0 5px rgba(96, 165, 250, 0.5); }
        50% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.8), 0 0 30px rgba(96, 165, 250, 0.4); }
      }

      /* Table container */
      .table-container {
        background: #7B6B43;
        backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.2);
        position: relative;
        max-height: 150vh; /* Set maximum height */
      }

      /* Table wrapper for scrolling */
      .table-wrapper {
        max-height: 60vh;       /* Maximum height before scrolling */
        overflow-y: auto;       /* Enable vertical scrolling */
        overflow-x: auto;       /* Enable horizontal scrolling for mobile */
        border-radius: 20px;    /* Match container border radius */
      }

      .table-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
      }

      /* Custom scrollbar styling */
      .table-wrapper::-webkit-scrollbar {
        width: 8px; /* Width of vertical scrollbar */
        height: 8px; /* Height of horizontal scrollbar */
      }

      .table-wrapper::-webkit-scrollbar-track {
        background: rgba(148, 163, 184, 0.1); /* Track color */
        border-radius: 4px;
      }

      .table-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #E1BB80 0%, #D6D6B1 100%); /* Scrollbar color */
        border-radius: 4px;
        transition: all 0.3s ease;
      }

      .table-wrapper::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #E1BB80 0%, #E1BB80 100%); /* Darker on hover */
        box-shadow: 0 0 8px rgba(96, 165, 250, 0.4);
      }

      .table-wrapper::-webkit-scrollbar-corner {
        background: rgba(148, 163, 184, 0.1); /* Corner where scrollbars meet */
      }

      /* For Firefox */
      .table-wrapper {
        scrollbar-width: thin;
        scrollbar-color: #E1BB80 rgba(148, 163, 184, 0.1);
      }

      @media (max-width: 1024px) {
        .modern-table td {
          padding: 1rem 0.5rem;
          font-size: 0.75rem;
        }

        .modern-table th {
          padding: 1rem 0.5rem;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 2440px) {
        .modern-table th {
          padding: 1rem 0.5rem;
          font-size: 1.50rem;
        }
        
        .modern-table td {
          padding: 1rem 0.5rem;
          font-size: 1.3rem;
        }
      }
      
      /* Stats cards */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: #806443;
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 4px 10px 24px rgba(0, 0, 0, 0.15);
        padding: 1rem;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
        transform: rotate(45deg);
        transition: transform 0.6s;
      }

      .stat-number {
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #b8b8b8 0%, #dddddd 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: #cbd5e1;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      /* Control Panel Styling */
      .control-panel {
        background: #806443;
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 4px 10px 24px rgba(0, 0, 0, 0.15);
        padding: 2rem;
        margin-bottom: 2rem;
        display: flex;
        gap: 1.5rem;
        align-items: center;
        flex-wrap: wrap;
        overflow: hidden;
      }

      .control-panel::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
        transform: rotate(45deg);
        transition: transform 0.6s;
      }

      .control-panel label {
        color: #ffffff;
        font-weight: 600;
        font-size: 1.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      /* Custom Dropdown Styling */
      .custom-select {
        background: linear-gradient(135deg, #806443 0%, #685634 100%);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 1rem 2.5rem 1rem 1.5rem;
        font-size: 1.30rem;
        font-weight: 600;
        min-width: 200px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        appearance: none;
        background-image: 
          linear-gradient(45deg, transparent 50%, white 50%),
          linear-gradient(135deg, white 50%, transparent 50%);
        background-position: 
          calc(100% - 20px) calc(1rem + 13px),
          calc(100% - 15px) calc(1rem + 13px);
        background-size: 5px 5px, 5px 5px;
        background-repeat: no-repeat;
      }
      
      .custom-select:focus {
        outline: none;
        border-color: #E1BB80;
        box-shadow: 0 0 0 3px rgba(225, 187, 128, 0.3);
      }

      .custom-select option {
        background: #685634;
        color: white;
        padding: 1rem;
      }

      /* Download Button Enhancement */
      #downloadBtn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.6rem;
      }

      #downloadBtn:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      }

      #downloadBtn::before {
        content: '';
        font-size: 1.6rem;
      }

      /* Loading state */
      .loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
      }

      .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid transparent;
        border-top: 2px solid #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Toast notification */
      #toast {
        position: fixed;
        bottom: 13px;
        left: 50%;
        min-width: 200px;
        max-width: 90vw;
        font-size: 1.75rem;
        width: auto;
        right: auto;
        margin: 0 auto;
        text-align: center;
        background: #806443;
        color: white;
        padding: 14px 22px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 6px 12px rgba(59,130,246,0.4);
        opacity: 0;
        pointer-events: none;
        transform: translateX(-50%) translateY(50%);
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 10500;
      }

      #toast.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateX(-50%) translateY(0);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .control-panel {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .custom-select {
          min-width: 100%;
        }
      }

    </style>
  </head>
  <body>
    <!-- Header Section -->
    <!-- <div class="dashboard-header">
      <h1 class="judul">DAFTAR ANTRIAN</h1>
    </div> -->

    <!-- Stats Section -->
    <div class="stats-container" id="statsContainer">
      <div class="stat-card">
        <div class="stat-number" id="totalToday">0</div>
        <div class="stat-label">Total Hari Ini</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-number" id="totalMonth">0</div>
        <div class="stat-label">Total Bulan Ini</div>
      </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
      <label for="monthSelect" class="month-select">Pilih Bulan:</label>
      <select id="monthSelect" class="custom-select">
        <!-- JS will fill this -->
      </select>
      <button id="downloadBtn">Download Excel</button>
    </div>

    <!-- Table Section -->
    <div class="table-container">
      <div class="table-wrapper">
        <table class="modern-table" id="antrianTable">      
          <thead>
            <tr>
              <th>No Antrian</th>
              <th>Kode Satker</th>
              <th>Nama Satker</th>
              <th>Nomor HP</th>
              <th>Keperluan</th>
              <th>Waktu</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
  
      <!-- Empty State -->
      <div id="emptyState" class="empty-state hidden">
        <div class="empty-state-icon">📋</div>
        <h3 class="empty_state text-white">Tidak ada entri antrean untuk hari ini</h3>
        <p class="empty_state text-white">Entri antrean akan muncul di sini saat dikirimkan</p>
      </div>
    </div>

    <div class="text-center text-black/70 mt-4">
        <small>
            <span class="text-xl">© 2025 CNCrew, KPPN Jayapura. All Rights Reserved</span>
        </small>
    </div>

    <div id="toast" role="alert" aria-live="polite" aria-atomic="true"></div>

    <script>
      const { createClient } = supabase;
      const supabaseUrl = "https://finxocxyrjizxjvvcbim.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpbnhvY3h5cmppenhqdnZjYmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5ODM1MjcsImV4cCI6MjA3MzU1OTUyN30.wK5N8xoDococE7AfACmP8LPh-nXE-lqKZte15MSM8P4";
      const supabaseClient = createClient(supabaseUrl, supabaseKey);

      const tbody = document.querySelector("#antrianTable tbody");
      const emptyState = document.getElementById("emptyState");
      const today = new Date().toISOString().split("T")[0];
      let queueData = [];
      let monthlyData = [];

      // Stats elements
      const totalTodayEl = document.getElementById("totalToday");
      const totalMonthEl = document.getElementById("totalMonth");
      const downloadBtn = document.getElementById("downloadBtn");

      // Load monthly data for stats
      async function loadMonthlyData() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).toISOString();

        const { data, error } = await supabaseClient
          .from("antrian")
          .select("*")
          .gte("created_at", startOfMonth)
          .lte("created_at", endOfMonth);

        if (!error && data) {
          monthlyData = data;
        }
      }

      function updateStats() {
        const todayTotal = queueData.length;
        const monthTotal = monthlyData.length;
        
        totalTodayEl.textContent = todayTotal;
        totalMonthEl.textContent = monthTotal;
      }

      function showToast(msg){
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 2325);
      }

      function formatTime(dateString) {
        const date = new Date(dateString);
        const day = date.toLocaleDateString("id-ID", {
          day: "numeric",
          month: "short",
        });
        const time = date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        return `${day}<br><span class="time-display">${time}</span>`;
      }

      const monthSelect = document.getElementById("monthSelect");

      // Fill dropdown with the last 12 months
      function populateMonths() {
        const now = new Date();
        for (let i = 0; i < 12; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          const label = d.toLocaleDateString("id-ID", { year: "numeric", month: "long" });
          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = label;
          if (i === 0) opt.selected = true; // default = current month
          monthSelect.appendChild(opt);
        }
      }
      populateMonths();

      function addRow(row, isNew = false) {
        const timeFormatted = formatTime(row.created_at);
        const tr = document.createElement("tr");
        if (isNew) {
          tr.classList.add("new-entry");
        }

        tr.innerHTML = `
          <td class="text-center">${row.nomor_antrian}</td>
          <td class="text-center">${row.kode}</td>
          <td class="text-center">${row.nama}</td>
          <td class="text-center">${row.phone}</td>
          <td class="text-center">${row.deskripsi || ""}</td>
          <td class="text-center">${timeFormatted}</td>
          <td class="text-center">
            <button onclick='printAntrian(${JSON.stringify(row).replace(/'/g, "\\'")})'
                    class="bg-green-500 text-white px-2 py-1 rounded">Print</button>
          </td>
        `;

        if (isNew && tbody.firstChild) {
          tbody.insertBefore(tr, tbody.firstChild);
        } else {
          tbody.appendChild(tr);
        }

        // Update empty state
        emptyState.classList.add("hidden");

        if (isNew) {
          tr.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }

      //Function for setting up UTC+9
      async function getJayapuraDayRange() {
        let serverNow;

        // 1. Try to fetch server time from Supabase
        try {
          const { data, error } = await supabaseClient.rpc("get_server_time");
          if (error) throw error;
          serverNow = new Date(data);
          console.log("Using Supabase server time:", serverNow.toISOString());
        } catch (err) {
          console.warn("Falling back to local time:", err.message);
          serverNow = new Date();
        }

        // 2. Define Jayapura offset (+9 hours from UTC)
        const jayapuraOffset = 9 * 60; // minutes

        // Start time
        const start = new Date(serverNow);
        start.setUTCHours(0, 0, 0, 0); // reset to UTC midnight
        start.setMinutes(start.getMinutes() + jayapuraOffset + 13 * 60);

        // If now < 07:00 Jayapura, then use yesterday’s 07:00
        if (serverNow < start) {
          start.setDate(start.getDate() - 1);
        }

        // End time
        const end = new Date(start);
        end.setDate(start.getDate() + 1);
        end.setSeconds(end.getSeconds() - 1);

        // Debug logs
        console.log("Start (Jayapura):", start.toLocaleString("id-ID", { timeZone: "Asia/Jayapura" }));
        console.log("End   (Jayapura):", end.toLocaleString("id-ID", { timeZone: "Asia/Jayapura" }));
        console.log("Start (UTC ISO):", start.toISOString());
        console.log("End   (UTC ISO):", end.toISOString());

        return {
          start: start.toISOString(),
          end: end.toISOString(),
        };
      }

      async function loadAntrian() {
        const range = await getJayapuraDayRange();

        if (range) {
          const { data, error } = await supabaseClient
            .from("antrian")
            .select("*")
            .gte("created_at", range.start)
            .lte("created_at", range.end)
            .order("created_at", { ascending: false });

          if (error) {
            console.error("Error loading today's rows:", error.message);
          } else {
            console.log("Today's rows:", data);
          }

        queueData = data;
        tbody.innerHTML = "";

        if (data.length === 0) {
          emptyState.classList.remove("hidden");
        } else {
          emptyState.classList.add("hidden");
          data.forEach(row => addRow(row));
        }

        updateStats();
        }
      }

      function printAntrian(row) {
        const w = window.open("", "_blank", "width=400,height=400");

        const tanggal = new Date(row.created_at).toLocaleString("id-ID", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });

        w.document.write(`
        <div style="font-family: sans-serif; text-align: center; margin-top: 80px; padding: 10px; justify-content: center;">
          <h1 style="font-size: 28px; font-weight: bold; margin-bottom: 20px;">Nomor Antrian</h1>
          <div style="font-size: 50px; font-weight: bold; margin-bottom: 25px;">${row.nomor_antrian}</div>
          <p style="font-size: 18px; margin: 5px 0; font-weight: bold;">${row.kode}</p>
          <p style="font-size: 18px; margin: 5px 0; font-weight: bold;">${row.nama}</p>
          <p style="font-size: 18px; margin: 5px 0;">${row.deskripsi || "-"}</p>
          <p style="font-size: 16px; margin: 5px 0;">${tanggal}</p>
        </div>
        `);
        setTimeout(() => w.print(), 500);
      }

      async function downloadMonthData(monthValue) {
        // Add loading state
        downloadBtn.classList.add('loading');
        downloadBtn.textContent = 'Downloading...';

        try {
          const [year, month] = monthValue.split("-");
          
          // Calculate start and end dates properly
          const startDate = new Date(parseInt(year), parseInt(month) - 1, 1);
          const endDate = new Date(parseInt(year), parseInt(month), 0, 23, 59, 59);
          
          const startStr = startDate.toISOString();
          const endStr = endDate.toISOString();

          console.log(`Selected month: ${monthValue}`);
          console.log(`Fetching data from ${startStr} to ${endStr}`);

          // First, let's check what data exists in the table for debugging
          const { data: allData, error: debugError } = await supabaseClient
            .from("antrian")
            .select("created_at")
            .order("created_at", { ascending: false })
            .limit(10);

          if (!debugError && allData) {
            console.log("Recent entries in database:", allData.map(item => item.created_at));
          }

          // Try a simpler approach first - just get all data for the year-month
          const { data, error } = await supabaseClient
            .from("antrian")
            .select("nomor_antrian, kode, nama, phone, deskripsi, created_at")
            .gte("created_at", `${year}-${month}-01T00:00:00.000Z`)
            .lt("created_at", `${year}-${String(parseInt(month) + 1).padStart(2, '0')}-01T00:00:00.000Z`)
            .order("created_at", { ascending: true });

          console.log(`Query result:`, { dataLength: data?.length || 0, error });

          if (error) {
            console.error("Supabase error:", error);
            showToast("Error mengambil data: " + error.message);
            return;
          }

          if (!data || data.length === 0) {
            // Show more detailed debug info
            console.log("No data found. Let's check what's available:");
            
            // Check if there's any data in the table at all
            const { data: anyData, error: anyError } = await supabaseClient
              .from("antrian")
              .select("created_at")
              .limit(5);
              
            if (!anyError && anyData) {
              console.log("Available data samples:", anyData);
              const dates = anyData.map(item => new Date(item.created_at).toLocaleDateString('id-ID'));
              showToast(`Tidak ada data untuk ${monthValue}.`);
            } else {
              showToast("Tidak ada data dalam database atau terjadi error.");
            }
            return;
          }

          console.log(`Found ${data.length} records for ${monthValue}`);

          // Format data for Excel
          const formattedData = data.map(row => ({
            'No Antrian': row.nomor_antrian,
            'Kode Satker': row.kode,
            'Nama Satker': row.nama,
            'Nomor HP': row.phone,
            'Keperluan': row.deskripsi || '',
            'Tanggal': new Date(row.created_at).toLocaleDateString('id-ID'),
            'Waktu': new Date(row.created_at).toLocaleTimeString('id-ID', { 
              hour12: false,
              hour: '2-digit',
              minute: '2-digit'
            })
          }));

          // Create Excel workbook
          const worksheet = XLSX.utils.json_to_sheet(formattedData);
          
          // Set column widths
          const colWidths = [
            { wch: 12 }, // No Antrian
            { wch: 15 }, // Kode Satker
            { wch: 30 }, // Nama Satker
            { wch: 15 }, // Nomor HP
            { wch: 30 }, // Keperluan
            { wch: 12 }, // Tanggal
            { wch: 8 }   // Waktu
          ];
          worksheet['!cols'] = colWidths;

          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Data Antrian");

          // Generate filename
          const monthName = new Date(parseInt(year), parseInt(month) - 1).toLocaleDateString('id-ID', { 
            year: 'numeric', 
            month: 'long' 
          });
          const filename = `Antrian_${monthName.replace(' ', '_')}.xlsx`;

          // Download file
          XLSX.writeFile(workbook, filename);
          
          // Show success message
          showToast(`Data berhasil didownload!\nTotal: ${data.length} entri untuk ${monthName}`);

        } catch (err) {
          console.error("Download error:", err);
          showToast("Terjadi kesalahan saat download: " + err.message);
        } finally {
          // Remove loading state
          downloadBtn.classList.remove('loading');
          downloadBtn.textContent = 'Download Excel';
        }
      }

      async function init() {
        // Load today's data and monthly data
        await Promise.all([
          loadAntrian(),
          loadMonthlyData()
        ]);

        // Subscribe to real-time changes
        supabaseClient
          .channel("antrian-realtime")
          .on("postgres_changes", 
              { event: "INSERT", schema: "public", table: "antrian" }, 
              (payload) => {
                const row = payload.new;
                const rowDate = new Date(row.created_at).toISOString().split("T")[0];
                
                if (rowDate === today) {
                  queueData.unshift(row);
                  addRow(row, true);
                  
                  // Also add to monthly data if it's current month
                  const now = new Date();
                  const rowMonth = new Date(row.created_at);
                  if (rowMonth.getMonth() === now.getMonth() && 
                      rowMonth.getFullYear() === now.getFullYear()) {
                    monthlyData.push(row);
                  }
                  
                  updateStats();
                }
              }
          )
          .subscribe();

      }

      // Hook download button
      downloadBtn.addEventListener("click", () => {
        const monthValue = monthSelect.value;
        if (!monthValue) {
          showToast("Silakan pilih bulan terlebih dahulu.");
          return;
        }
        downloadMonthData(monthValue);
      });

      // Make printAntrian globally available
      window.printAntrian = printAntrian;

      // Initialize the application
      init();

    </script>
  </body>
</html>