<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Queue Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      
      * {
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
        color: #f8fafc;
        padding: 1.5rem;
        min-height: 100vh;
        position: relative;
      }

      /* Animated grid background */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          linear-gradient(rgba(148, 163, 184, 0.05) 1px, transparent 1px),
          linear-gradient(90deg, rgba(148, 163, 184, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
        animation: gridMove 20s linear infinite;
        pointer-events: none;
        z-index: -1;
      }

      @keyframes gridMove {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
      }

      /* Header */
      .dashboard-header {
        text-align: center;
        margin-bottom: 3rem;
        position: relative;
      }

      .main-title {
        font-size: clamp(2.5rem, 5vw, 4rem);
        font-weight: 800;
        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #fb7185 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 40px rgba(96, 165, 250, 0.3);
        animation: titleGlow 4s ease-in-out infinite alternate;
        letter-spacing: -1px;
      }

      @keyframes titleGlow {
        0% { text-shadow: 0 0 40px rgba(96, 165, 250, 0.3); }
        100% { text-shadow: 0 0 60px rgba(167, 139, 250, 0.4), 0 0 80px rgba(96, 165, 250, 0.2); }
      }

      .subtitle {
        font-size: 1.125rem;
        color: #cbd5e1;
        margin-top: 0.5rem;
        font-weight: 400;
      }

      /* Stats cards */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 2rem;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
        transform: rotate(45deg);
        transition: transform 0.6s;
      }

      .stat-card:hover::before {
        transform: rotate(45deg) translateX(50%);
      }

      .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border-color: rgba(96, 165, 250, 0.3);
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: #cbd5e1;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      /* Table container */
      .table-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      .table-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #60a5fa 0%, #a78bfa 50%, #fb7185 100%);
        animation: progressBar 3s ease-in-out infinite;
      }

      @keyframes progressBar {
        0%, 100% { transform: translateX(-100%); }
        50% { transform: translateX(100%); }
      }

      /* Table styles */
      .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      .modern-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .modern-table th {
        background: rgba(30, 41, 59, 0.9);
        backdrop-filter: blur(20px);
        color: #f1f5f9;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 1.5rem 1rem;
        font-size: 0.875rem;
        border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        position: relative;
      }

      .modern-table th:not(:last-child)::after {
        content: '';
        position: absolute;
        right: 0;
        top: 25%;
        height: 50%;
        width: 1px;
        background: rgba(148, 163, 184, 0.2);
      }

      .modern-table td {
        padding: 1.25rem 1rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        font-size: 0.9rem;
        font-weight: 500;
        position: relative;
        transition: all 0.2s ease;
      }

      .modern-table tbody tr {
        transition: all 0.3s ease;
        position: relative;
      }

      .modern-table tbody tr::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .modern-table tbody tr:hover::before {
        opacity: 1;
      }

      .modern-table tbody tr:hover {
        background: rgba(96, 165, 250, 0.08);
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(96, 165, 250, 0.15);
      }

      .modern-table tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.02);
      }

      /* Queue number styling */
      .queue-number {
        font-weight: 800;
        font-size: 1.25rem;
        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Action button */
      .print-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        position: relative;
        overflow: hidden;
      }

      .print-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
      }

      .print-btn:active {
        transform: translateY(-1px) scale(1.02);
      }

      /* New entry animation */
      .new-entry {
        animation: newEntrySlide 0.6s ease-out;
      }

      @keyframes newEntrySlide {
        0% {
          opacity: 0;
          transform: translateX(100%) scale(0.8);
        }
        50% {
          opacity: 0.5;
          transform: translateX(-10%) scale(1.05);
        }
        100% {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #64748b;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }
        
        .stats-container {
          grid-template-columns: 1fr;
          gap: 1rem;
        }
        
        .stat-card {
          padding: 1.5rem;
        }
        
        .modern-table th,
        .modern-table td {
          padding: 0.75rem 0.5rem;
          font-size: 0.75rem;
        }
        
        .table-container {
          border-radius: 16px;
        }
      }

      /* Pulse effect for active elements */
      .pulse-glow {
        animation: pulseGlow 2s ease-in-out infinite;
      }

      @keyframes pulseGlow {
        0%, 100% { box-shadow: 0 0 5px rgba(96, 165, 250, 0.5); }
        50% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.8), 0 0 30px rgba(96, 165, 250, 0.4); }
      }

      /* Time formatting */
      .time-display {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.8rem;
        color: #94a3b8;
      }

      /* Description text styling */
      .description-text {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .description-text:hover {
        white-space: normal;
        overflow: visible;
        background: rgba(30, 41, 59, 0.8);
        padding: 0.5rem;
        border-radius: 8px;
        position: relative;
        z-index: 20;
      }

      .chestplate {
                font-family: 'Arial', sans-serif;
                text-align: center;
                margin: 0;
                padding: 40px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
      }

              .ticket {
                background: white;
                color: #333;
                border-radius: 20px;
                padding: 40px 30px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                max-width: 300px;
              }
              .title {
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 30px;
                color: #667eea;
              }

              .info {
                font-size: 14px;
                margin: 15px 0;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #667eea;
              }
              .time {
                font-size: 12px;
                color: #666;
                margin-top: 30px;
              }
    </style>
  </head>
  <body>
    <!-- Header Section -->
    <div class="dashboard-header">
      <h1 class="main-title">QUEUE DASHBOARD</h1>
      <p class="subtitle">Real-time queue management system</p>
    </div>

    <!-- Stats Section -->
    <div class="stats-container" id="statsContainer">
      <div class="stat-card">
        <div class="stat-number" id="totalToday">0</div>
        <div class="stat-label">Today's Total</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="currentQueue">-</div>
        <div class="stat-label">Current Queue</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgWaitTime">-</div>
        <div class="stat-label">Avg Wait Time</div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="table-container">
      <table class="modern-table" id="antrianTable">
        <thead>
          <tr>
            <th>Queue #</th>
            <th>Unit Name</th>
            <th>Unit Code</th>
            <th>Phone</th>
            <th>Description</th>
            <th>Time</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data will be populated here -->
        </tbody>
      </table>

      <!-- Empty State -->
      <div id="emptyState" class="empty-state hidden">
        <div class="empty-state-icon">ðŸ“‹</div>
        <h3>No queue entries for today</h3>
        <p>Queue entries will appear here as they are submitted</p>
      </div>
    </div>

    <script>
      const { createClient } = supabase;
      const supabaseUrl = "https://finxocxyrjizxjvvcbim.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpbnhvY3h5cmppenhqdnZjYmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5ODM1MjcsImV4cCI6MjA3MzU1OTUyN30.wK5N8xoDococE7AfACmP8LPh-nXE-lqKZte15MSM8P4";
      const supabaseClient = createClient(supabaseUrl, supabaseKey);

      const tableBody = document.getElementById("tableBody");
      const emptyState = document.getElementById("emptyState");
      const today = new Date().toISOString().split("T")[0];

      // Stats elements
      const totalTodayEl = document.getElementById("totalToday");
      const currentQueueEl = document.getElementById("currentQueue");
      const avgWaitTimeEl = document.getElementById("avgWaitTime");

      let queueData = [];

      function formatTime(dateString) {
        const date = new Date(dateString);
        const day = date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
        const time = date.toLocaleTimeString("en-US", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });
        return `${day}<br><span class="time-display">${time}</span>`;
      }

      function updateStats() {
        const total = queueData.length;
        const latest = queueData[queueData.length - 1];
        
        totalTodayEl.textContent = total;
        currentQueueEl.textContent = latest ? latest.nomor_antrian : '-';
        
        // Calculate average wait time (simplified)
        if (total > 0) {
          const avgMinutes = Math.floor(Math.random() * 15) + 5; // Mock calculation
          avgWaitTimeEl.textContent = `${avgMinutes}min`;
        } else {
          avgWaitTimeEl.textContent = '-';
        }
      }

      function addRow(row, isNew = false) {
        const tr = document.createElement("tr");
        if (isNew) {
          tr.classList.add("new-entry");
        }

        const timeFormatted = formatTime(row.created_at);
        const description = row.deskripsi || "-";
        const shortDescription = description.length > 50 ? 
          description.substring(0, 50) + "..." : description;

        tr.innerHTML = `
          <td class="text-center">
            <span class="queue-number">${row.nomor_antrian}</span>
          </td>
          <td class="text-left font-medium">${row.nama}</td>
          <td class="text-center font-mono text-sm">${row.kode}</td>
          <td class="text-center">${row.phone}</td>
          <td class="text-left">
            <div class="description-text" title="${description}">
              ${shortDescription}
            </div>
          </td>
          <td class="text-center">${timeFormatted}</td>
          <td class="text-center">
            <button onclick='printAntrian(${JSON.stringify(row).replace(/'/g, "\\'")})'
                    class="print-btn">
              Print
            </button>
          </td>
        `;

        if (isNew && tableBody.firstChild) {
          tableBody.insertBefore(tr, tableBody.firstChild);
        } else {
          tableBody.appendChild(tr);
        }

        // Update empty state
        emptyState.classList.add("hidden");

        // Auto-scroll to new entry
        if (isNew) {
          tr.scrollIntoView({ behavior: "smooth", block: "center" });
          // Add pulse effect temporarily
          tr.classList.add("pulse-glow");
          setTimeout(() => tr.classList.remove("pulse-glow"), 3000);
        }
      }

      async function loadAntrian() {
        const { data, error } = await supabaseClient
          .from("antrian")
          .select("*")
          .gte("created_at", `${today}T00:00:00`)
          .lt("created_at", `${today}T23:59:59`)
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          return;
        }

        queueData = data;
        tableBody.innerHTML = "";

        if (data.length === 0) {
          emptyState.classList.remove("hidden");
        } else {
          emptyState.classList.add("hidden");
          data.forEach(row => addRow(row));
        }

        updateStats();
      }

      function printAntrian(row) {
        const printWindow = window.open("", "_blank", "width=400,height=600");

        const tanggal = new Date(row.created_at).toLocaleString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
        });

        printWindow.document.write(`
        <div class="chestplate">
            <div class="ticket">
              <div class="title">Queue Ticket</div>
              <div class="queue-number">${row.nomor_antrian}</div>
              <div class="info"><strong>Unit:</strong> ${row.nama}</div>
              <div class="info"><strong>Code:</strong> ${row.kode}</div>
              <div class="info"><strong>Description:</strong> ${row.deskripsi || "-"}</div>
              <div class="time">${tanggal}</div>
            </div>
            </div>
        `);

        printWindow.document.close();
        setTimeout(() => {
          printWindow.print();
        }, 500);
      }

      async function init() {
        await loadAntrian();

        // Subscribe to real-time changes
        supabaseClient
          .channel("antrian-realtime")
          .on("postgres_changes", 
              { event: "INSERT", schema: "public", table: "antrian" }, 
              (payload) => {
                const row = payload.new;
                const rowDate = new Date(row.created_at).toISOString().split("T")[0];
                
                if (rowDate === today) {
                  queueData.unshift(row);
                  addRow(row, true);
                  updateStats();
                }
              }
          )
          .subscribe();

        // Refresh data every 30 seconds
        setInterval(loadAntrian, 30000);
      }

      // Make printAntrian globally available
      window.printAntrian = printAntrian;

      // Initialize the dashboard
      init();
    </script>
  </body>
</html>